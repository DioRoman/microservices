## Общее описание архитектуры проекта

Проект представляет собой микросервисную систему, упакованную и управляемую через Docker Compose. Архитектура разделена по функционалу на следующие компоненты:

- **MinIO (service: storage)** — объектное хранилище, совместимое с Amazon S3, отвечает за хранение изображений. Данные хранятся в volume `data`.
- **CreateBuckets** — инициализационный сервис, который создаёт бакет `images` на MinIO и задаёт политики доступа при старте.
- **Uploader (service: uploader)** — микросервис на Node.js, который принимает запросы на загрузку изображений через HTTP. Принимает файлы, проверяет MIME, генерирует уникальное имя и загружает в MinIO через S3-совместимый клиент.
- **Security (service: security)** — микросервис на Python/Flask для аутентификации. Выдаёт JWT токены и проверяет их валидность. Использует PBKDF2 для хеширования паролей.
- **Gateway (nginx)** — обратный прокси-сервер на базе Nginx, маршрутизирующий запросы к вышеописанным микросервисам. Реализует механизмы авторизации через subrequest `/auth`, защищает эндпоинты и проксирует запросы в нужный сервис.

***

## Особенности взаимосвязи:

- Клиент взаимодействует с `gateway`, который перенаправляет запросы на:
  - `security` для регистрации, логина и валидации токенов.
  - `uploader` для загрузки изображений (защищён эндпоинт).
  - `storage` (MinIO) для получения доступа к изображениям (защищён).
- Все сервисы соединены внутри сети Docker Compose, порты снаружи проброшены только для gateway (80) и MinIO (9000).
- Prometheus метрики собраны в микросервисах `security` и `uploader` для мониторинга.

***

## Стек технологий:

| Компонент          | Технологии/Инструменты               | Роль                           |
|--------------------|------------------------------------|--------------------------------|
| storage            | MinIO, Docker Volume                | Объектное хранилище            |
| createbuckets      | MinIO mc CLI, Docker Init Container | Инициализация бакетов          |
| uploader           | Node.js, Express, MinIO SDK, Prometheus middleware | Загрузка файлов, API          |
| security           | Python, Flask, JWT, PBKDF2, Prometheus exporter | Аутентификация и авторизация  |
| gateway            | Nginx                             | Реверс-прокси, авторизация     |
| Оркестрация        | Docker Compose                    | Контейнеризация и сеть         |

***

## Схема архитектуры (текстовое представление)

```
  Клиент (HTTP)
      |
      v
  +------------+
  |   Gateway  |  (Nginx, port 80)
  +--+-------+-+
     |       |
     |       +--> /v1/upload (POST) ---> Uploader (Node.js, port 3000)
     |       |
     |       +--> /v1/register, /v1/token --> Security (Flask, port 3000)
     |       |
     |       +--> /v1/user/...  -----------+ 
     |                                   |
     |                                   v
     |                             Storage (MinIO, port 9000)
     |
     +--- Healthchecks `/status` and metrics `/metrics`
```

***

## Потоки запросов:

1. Клиент запрашивает регистрацию или логин у `security` через `gateway`.
2. При успешной авторизации клиент получает JWT, который отправляется в заголовках для защищённых маршрутов.
3. При загрузке файла клиент делает POST на `/v1/upload` у `gateway`, который проксирует запрос в `uploader`.
4. Uploader проверяет файл, сохраняет в MinIO с помощью S3-совместимого клиента.
5. При запросах к данным `/v1/user/{filename}` gateway проверяет JWT и проксирует запрос к MinIO.
