# Документация проекта Redis Cluster на Docker Compose

***

## Описание проекта

Данный проект представляет собой пример развертывания Redis Cluster с 3 мастерами (shard 1, 2, 3) и 3 репликами (replica 1, 2, 3), сгруппированными по трем виртуальным машинам (эмулируется через 3 Docker контейнера).  

Redis Cluster обеспечивает горизонтальное масштабирование и отказоустойчивость за счет шардирования данных и репликации.

***

## Структура проекта

```
redis-cluster-project/
│
├── docker-compose.yml             # Определение сервисов Redis и сети
├── conf/                         # Конфигурационные файлы каждого Redis-инстанса
│   ├── vm1-shard1.conf
│   ├── vm1-replica2.conf
│   ├── vm2-shard2.conf
│   ├── vm2-replica3.conf
│   ├── vm3-shard3.conf
│   └── vm3-replica1.conf
└── data/                         # Папки для хранения данных каждого VM
    ├── vm1/
    ├── vm2/
    └── vm3/
```

***

## Рекомендуемые системные требования и настройки

- Хост-машина с ОС Linux (или WSL2 для Windows).  
- Docker версии не ниже 20.x, Docker Compose версии 1.27+.  
- Объем оперативной памяти не менее 4 ГБ для адекватной работы Redis и его процессов.  
- Установленный параметр ядра Linux `vm.overcommit_memory=1` для корректной работы Redis с памятью.  
- Открытые порты TCP 7001-7006 (или ваши кастомные порты) для взаимодействия между нодами.  
- Желательно отключить swap (рекомендуется для Redis), либо настроить его адекватно.

Настройка параметра памяти (на хосте) выполняется:

```bash
sudo sysctl -w vm.overcommit_memory=1
sudo sh -c "echo 'vm.overcommit_memory=1' >> /etc/sysctl.conf"
```

***

## Запуск и настройка кластера

1. **Соберите структуру проекта и сохраните файлы конфигурации** (пример конфигов в директории `conf/`).

2. **Запустите контейнеры командой:**

```bash
docker compose up -d
```

<img width="1765" height="313" alt="Снимок экрана 2025-09-01 235218" src="https://github.com/user-attachments/assets/ca99f001-25de-4e94-82fc-c13101e60207" />

3. **Создайте Redis Cluster, выполнив команду из одного из контейнеров:**

```bash
docker exec -it vm1 redis-cli --cluster create \
172.20.0.11:7001 172.20.0.12:7003 172.20.0.13:7005 \
172.20.0.13:7006 172.20.0.11:7002 172.20.0.12:7004 \
--cluster-replicas 1
```

Подтвердите создание, набрав `yes`.

4. **Проверьте статус кластера:**

```bash
docker exec -it vm1 redis-cli -p 7001 cluster info
```

<img width="1239" height="425" alt="Снимок экрана 2025-09-01 235257" src="https://github.com/user-attachments/assets/342632fe-0258-495f-ba96-c10aa7456d7d" />

В поле `cluster_state` должно быть значение `ok`.

<img width="1458" height="202" alt="Снимок экрана 2025-09-01 235313" src="https://github.com/user-attachments/assets/2ab2e504-9573-4968-842d-40a60e445016" />

***

## Особенности Redis Cluster

- Кластер делит ключи на 16384 слотов, которые равномерно распределяются между мастерами.  
- Каждая реплика настроена на отказоустойчивость, она может стать мастером при падении основного узла.  
- Все взаимодействия внутри кластера происходят автоматически, клиентские запросы автоматически маршрутизируются к нужным нодам.  
- В режиме кластера Redis использует только одну базу данных (db 0).

***

## Рекомендации по эксплуатации

- Используйте `restart: unless-stopped` в docker-compose.yml для авто-перезапуска контейнеров при сбоях.  
- Внимательно следите за логами Redis на предмет ошибок и предупреждений.  
- Регулярно делайте бэкапы данных.  
- Следите за загрузкой памяти и ресурсов хоста.  
- Настройте мониторинг состояния кластера с помощью команд `CLUSTER INFO`, `CLUSTER NODES`.  
- При обновлении кластера соблюдайте процедуры graceful upgrade.
